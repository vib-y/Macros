local Players = game:GetService('Players')
local CoreGui = game:GetService('StarterGui')
local GuiService = game:GetService('GuiService')
local ReplicatedStorage = game:GetService('ReplicatedStorage')
local ContextActionService = game:GetService('ContextActionService')
local VirtualInputManager = cloneref(game:GetService('VirtualInputManager'))
local UserInputService = game:GetService('UserInputService')
local LocalPlayer = Players.LocalPlayer
local Enabled = false
local Rod = false
local Casted = false
local Progress = false
local Finished = false
local lastfish = os.clock()

local Keybind = Enum.KeyCode.F

function ShowNotification(String)
    CoreGui:SetCore('SendNotification', {
        Title = 'Notification',
        Text = String,
        Duration = 1
    })
end

function ToggleFarm(Name, State, Input)
    if State == Enum.UserInputState.Begin then
        Enabled = not Enabled
        --LocalPlayer.Character.Torso.Anchored = Enabled
      
        if not Enabled then
            Finished = false
            Progress = false
            GuiService.SelectedObject = nil

            lastfish = os.clock()
          
            if Rod then
                Rod.events.reset:FireServer()
            end
        end
      
        ShowNotification(`Status: {Enabled}`)
    end
end

LocalPlayer.Character.ChildAdded:Connect(function(Child)
    if Child:IsA('Tool') and Child.Name:lower():find('rod') then
        Rod = Child
    end
end)

LocalPlayer.Character.ChildRemoved:Connect(function(Child)
    if Child == Rod then
        Enabled = false
        Finished = false
        Progress = false
        Rod = nil
        GuiService.SelectedObject = nil
    end
end)

LocalPlayer.PlayerGui.DescendantAdded:Connect(function(Descendant)
    if Enabled then
        if Descendant.Name == 'button' and Descendant.Parent.Name == 'safezone' then
        elseif Descendant.Name == 'playerbar' and Descendant.Parent.Name == 'bar' then
            Finished = true
            Descendant:GetPropertyChangedSignal('Position'):Wait()
            ReplicatedStorage.events.reelfinished:FireServer(100, true)
        end
    end
end)

LocalPlayer.PlayerGui.DescendantRemoving:Connect(function(Descendant)
    if Descendant.Name == 'reel' then
        Finished = false
        Progress = false
        lastfish = os.clock()
    end
end)

coroutine.wrap(function()
    while true do
        if Enabled and not Progress then
            if Rod then
                Progress = true
                task.wait(0.5)
                Rod.events.reset:FireServer()
                Rod.events.cast:FireServer(100.5)
            end
        end
  
        task.wait()
    end
end)()

local NewRod = LocalPlayer.Character:FindFirstChildWhichIsA('Tool')

if NewRod and NewRod.Name:lower():find('rod') then
    Rod = NewRod
end

if not UserInputService.KeyboardEnabled then
    ContextActionService:BindAction('ToggleFarm', ToggleFarm, false, Keybind, Enum.UserInputType.Touch)
    ContextActionService:SetTitle('ToggleFarm', 'Toggle Farm')
    ContextActionService:SetPosition('ToggleFarm', UDim2.new(0.9, -50, 0.9, -150))
    ShowNotification('Press the onscreen button to enable/disable')
else
    ContextActionService:BindAction('ToggleFarm', ToggleFarm, false, Keybind)
    ShowNotification(`Press '{Keybind.Name}' to enable/disable`)
end

local Player = game:GetService("Players").LocalPlayer
local Character = Player.Character

local BodyPosition = Instance.new("BodyPosition")

local function Goto(Position)
    Character.HumanoidRootPart.CFrame = CFrame.new(Position.X, 133, Position.Z)
    BodyPosition.Position = Vector3.new(Position.X, 133, Position.Z)
    BodyPosition.MaxForce = Vector3.new(50000,5000,50000)
    BodyPosition.Parent = Character.HumanoidRootPart
end

Goto(Vector3.new(-833.31604, 127.447769, 1236.0365))

task.spawn(function()
    while task.wait(1) do
        if workspace.zones.fishing:FindFirstChild("FischFright24") then
            Goto(workspace.zones.fishing.FischFright24.Position)
        else
            Goto(Vector3.new(-833.31604, 127.447769, 1236.0365))
        end

        if Enabled then
            if (os.clock() - lastfish) > 50 then
                Finished = false
                Progress = false
                print("Reseting")
            end
        end
    end
end)

task.spawn(function()
    while task.wait() do
        if Player.PlayerGui:FindFirstChild("shakeui") then
            local Button = Player.PlayerGui.shakeui.safezone:FindFirstChild("button")
    
            if Button then
                GuiService.SelectedObject = Button
                VirtualInputManager:SendKeyEvent(true, Enum.KeyCode.Return, false, game)
                VirtualInputManager:SendKeyEvent(false, Enum.KeyCode.Return, false, game)
                GuiService.SelectedObject = nil
            end
        end
    end
end)
